<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Colloscope MPSI1</title>
        <style>
            .loading--hidden {
                display: none;
            }

            .student-info--hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <label for="name-input">Votre nom:</label>
        <input type="text" id="name-input" placeholder="Jean Dupont">

        <strong id="loading" class="loading--hidden">Chargement des données en cours...</strong>

        <div id="student-info" class="student-info--hidden">
            <ul>
                <li>Nom: <strong id="student-name"></strong></li>
                <li>Groupe: <strong id="student-group-number"></strong></li>
                <li>Colles: <ul id="student-colles"></ul></li>
            </ul>
        </div>

        <script>
            let data = null;

            function normalizeName(name) {
                return name.trim()
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "");
            }

            function doesStudentMatchSearch(input, studentName) {
                const inputNames = normalizeName(input).split(/[\s\-]+/);
                const studentNames = normalizeName(studentName).split(/[\s\-]+/);
                return inputNames
                    .some(i => studentNames.some(n => n.startsWith(i)));
            }

            function findStudent(input) {
                let result = null;
                for (let i in data.groups) {
                    const group = data.groups[i];
                    for (let studentName of group) {
                        if (doesStudentMatchSearch(input, studentName)) {
                            // If we have another match, then there is an
                            // ambiguation.
                            if (result !== null)
                                return null;
                            result = { name: studentName, group: parseInt(i) };
                        }
                    }
                }
                return result;
            }

            const loadingEl = document.getElementById("loading");
            const studentInfoEl = document.getElementById("student-info");
            const nameEl = document.getElementById("student-name");
            const groupNumberEl = document.getElementById("student-group-number");
            const collesEl = document.getElementById("student-colles");
            const nameInput = document.getElementById("name-input");

            let groupDisplayedIndex = null;

            nameInput.addEventListener("input", function(e) {
                refreshView();
            });

            function refreshView() {
                const showLoading = data === null && nameInput.value.trim() !== "";
                if (showLoading) {
                    loadingEl.classList.remove("loading--hidden");
                } else {
                    loadingEl.classList.add("loading--hidden");
                }

                if (data === null)
                    return;

                const student = findStudent(nameInput.value);
                if (student === null) {
                    studentInfoEl.classList.add("student-info--hidden");
                    return;
                } else {
                    studentInfoEl.classList.remove("student-info--hidden");
                }

                nameEl.textContent = student.name;

                if (student.group !== groupDisplayedIndex) {
                    groupNumberEl.textContent = student.group + 1;

                    const now = new Date().valueOf();
                    let weeks = [];
                    let lastWeekIndex = null;
                    for (let colle of data.colles[student.group]) {
                        const colleType = data.types[colle.type];
                        const week = data.weeks[colle.week]
                            .split("-")
                            .map(x => parseInt(x));
                        const month = week[0];
                        const year = month < 9 ? 2021 : 2020;
                        const startTime = new Date(year, month - 1, week[1], colleType.time);
                        startTime.setDate(startTime.getDate() + colleType.day);

                        let state;
                        if (now.valueOf() - startTime.valueOf() > 1000 * 60 * 60) {
                            state = "done";
                        } else if (now.valueOf() - startTime.valueOf() >= 0) {
                            state = "doing";
                        } else {
                            state = "waiting";
                        }

                        if (weeks.length === 0 || colle.week !== lastWeekIndex)
                            weeks.push({ index: colle.week, date: week, colles: [] });

                        weeks[weeks.length - 1].colles.push({
                            startTime,
                            state,
                            day: colleType.day,
                            subject: colleType.subject,
                            teacher: colleType.teacher,
                            room: colleType.room,
                        });
                        lastWeekIndex = colle.week;
                    }

                    // Remove weeks where all colles are already done.
                    weeks = weeks.filter(w => w.colles.some(c => c.state !== "done"));

                    while (collesEl.firstChild)
                        collesEl.firstChild.remove();
                    for (let week of weeks) {
                        const weekEl = document.createElement("li");
                        weekEl.textContent = `Semaine ${week.index + 1} (${week.date[1]}/${week.date[0]})`;

                        const colleList = document.createElement("ul");
                        for (let colle of week.colles) {
                            const days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
                            const day = days[colle.day];
                            const subject = data.subjects[colle.subject];
                            const teacher = data.teachers[colle.teacher];

                            const colleEl = document.createElement("li");
                            colleEl.textContent = `${day} à ${colle.startTime.getHours()}h : ${subject} avec ${teacher} en salle ${colle.room}`;
                            colleList.appendChild(colleEl);
                        }
                        weekEl.appendChild(colleList);

                        collesEl.appendChild(weekEl);
                    }

                    groupDisplayedIndex = student.group;
                }
            }

            async function loadData() {
                const response = await fetch("./data.json");
                if (!response.ok)
                    throw new Error("response is not OK");
                data = await response.json();
                refreshView();
            }
            loadData()
                .catch(err => console.error("failed to load data", err));
        </script>
    </body>
</html>
