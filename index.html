<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Colloscope</title>

        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
        <style>
            * {
                box-sizing: border-box;
            }

            html, body {
                margin: 0;
                padding: 0;
            }

            body {
                font-family: 'Open Sans', sans-serif;
                line-height: 1.6;
            }

            p, .name-form, .student-info, .week {
                margin: 2em 0;
            }

            .container {
                max-width: 70em;
                margin: 0 auto;
                padding: 4em 1em;
            }

            .title {
                margin: 0 0 1em 0;
                font-size: 2em;
            }

            .class-select {
                font-size: 1em;
            }

            .name-input {
                margin: 0.45em 0 0 0;
                display: block;
                font-size: 1em;
                padding: 0.4em;
            }

            .loading--hidden {
                display: none;
            }

            .student-info, .weeks .week:last-child {
                margin-bottom: 0;
            }

            .student-info--hidden {
                display: none;
            }

            .week__title {
                margin: 1em 0;
            }

            .week__colles {
                list-style-type: none;

                /* Remove the margin on the sides. */
                margin: -0.5em;
                padding: 0;
            }

            .colle {
                margin: 0.5em;

                display: inline-block;
                width: 18em;
                padding: 1em;

                border-style: solid;
                border-width: 0.2em;

                text-align: center;
            }

            .colle--waiting {
                border-color: #000000;
            }

            .colle--subject-0 {
                background-color: #376A8B;
                border-color: #083757;
                color: #FFFFFF;
            }

            .colle--subject-1 {
                background-color: #34714D;
                border-color: #073D1E;
                color: #FFFFFF;
            }

            .colle--subject-2 {
                background-color: #9B3838;
                border-color: #570808;
                color: #FFFFFF;
            }

            .colle--done {
                border-color: #AAAAAA;
            }

            .colle--doing {
                border-color: #E5FF00;
            }

            .colle__subject, .colle__info {
                margin: 0;
            }

            .colle__subject {
                font-weight: bold;
            }

            @media (prefers-color-scheme: dark) {
                body {
                    background-color: #000000;
                    color: #FFFFFF;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1 class="title">
                Colloscope

                <select id="class-select" class="class-select" aria-label="Classe">
                    <option value="mpsi1">MPSI1</option>
                    <option value="mp-star">MP*</option>
                </select>
            </h1>

            <form class="name-form">
                <label for="name-input">Entrez votre nom :</label>
                <input id="name-input" class="name-input" type="text"
                    placeholder="Jean Dupont">
            </form>

            <p id="loading" class="loading--hidden">
                <strong>Chargement des données en cours...</strong>
            </p>

            <div id="student-info" class="student-info student-info--hidden">
                <p class="student-info-fields">
                    Nom :
                    <strong id="student-name"></strong>
                    <br/>

                    Groupe de colle :
                    <strong id="student-group-number"></strong>
                </p>

                <div id="student-colles-weeks" class="weeks"
                    aria-label="Semaines de colles"></div>
            </div>
        </div>

        <!-- Promise polyfill -->
        <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8.1.3/dist/polyfill.min.js"
            integrity="sha384-Oa9qd3zGPgIOjIcotuclp6o+1G/FJtvOBKJRGkHSQt/nQWcZY/UwxnQYvVL5dfV5"
            crossorigin="anonymous"></script>

        <!-- window.fetch polyfill -->
        <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.4.1/dist/fetch.umd.js"
            integrity="sha384-TAa5y9Rxs8yDMCt2eJIiRaKxwO91TzC3OXOCLSTWjdTtZLaJsnKgW8KcAZM3pO12"
            crossorigin="anonymous"></script>

        <!-- String.prototype.normalize polyfill -->
        <script src="https://cdn.jsdelivr.net/npm/unorm@1.6.0/lib/unorm.js"
            integrity="sha384-NlTD8LJJeDI67+9TO5iY/XBhr4NDPQwVcCBbaciass3dvrmlFMNzWE1jeY6E0/ET"
            crossorigin="anonymous"></script>

        <script>
            "use strict";

            var dataByClass = {};
            var selectedClass;

            /**
             * Converts a difference between two {@code Date}s into a human
             * readable string in French.
             * @param from {Date} the starting date
             * @param to {Date} the target date
             */
            function formatRelativeTime(from, to) {
                var diffMs = to.valueOf() - from.valueOf();
                var diffAbsMs = Math.abs(diffMs);

                var minuteMs = 1000 * 60;
                var hourMs = minuteMs * 60;
                var dayMs = hourMs * 24;

                function isTimeBefore(a, b) {
                    return a.getHours() < b.getHours() || (a.getHours() === b.getHours() &&
                            (a.getMinutes() < b.getMinutes() || (a.getMinutes() === b.getMinutes() &&
                            (a.getSeconds() < b.getSeconds() || (a.getSeconds() === b.getSeconds() &&
                            a.getMilliseconds() < b.getMilliseconds())))));
                }

                function formatHelper(value, label) {
                    var result = "";
                    result += value > 0 ? "dans " : "il y a ";
                    result += value;
                    result += " ";
                    result += label;
                    if (Math.abs(value) > 1)
                        result += "s";
                    return result;
                }

                if (diffAbsMs < minuteMs) {
                    return "maintenant";
                } else if (diffAbsMs < 2 * hourMs) {
                    return formatHelper(Math.round(diffMs / minuteMs), "minute");
                } else {
                    var diffDays = Math.floor(diffAbsMs / dayMs);
                    if (diffMs > 0 && isTimeBefore(to, from)) {
                        // It's tomorrow, even though the difference with today
                        // is less than 24 hrs.
                        diffDays++;
                    } else if (diffMs < 0 && isTimeBefore(from, to)) {
                        // Opposite of above.
                        diffDays--;
                    }
                    if (diffDays === 0) {
                        return formatHelper(Math.round(diffMs / hourMs), "heure");
                    } else if (diffDays === -2) {
                        return "avant-hier";
                    } else if (diffDays === -1) {
                        return "hier";
                    } else if (diffDays === 1) {
                        return "demain";
                    } else if (diffDays === 2) {
                        return "après-demain";
                    }
                    return formatHelper(diffDays, "jour");
                }
            }

            /**
             * Search functions
             */

            function normalizeName(name) {
                name = name.trim()
                    .toLowerCase();
                // Remove accents
                return name.normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "");
            }

            function tokenizeName(name) {
                return normalizeName(name)
                    .split(/[\s\-]+/);
            }

            function getMatchScore(inputTokens, entryTokens) {
                // Make a copy of the arrays because we are going to modify
                // them.
                inputTokens = inputTokens.slice();
                entryTokens = entryTokens.slice();

                var score = 0;
                while (inputTokens.length > 0) {
                    var inputToken = inputTokens.pop();

                    var matchIndex = -1;
                    for (var i = 0; i < entryTokens.length; i++) {
                        if (entryTokens[i].indexOf(inputToken) === 0) {
                            matchIndex = i;
                            break;
                        }
                    }

                    if (matchIndex === -1) {
                        return 0;
                    } else {
                        score += inputToken.length;
                        entryTokens.splice(matchIndex, 1);
                    }
                }
                return score;
            }

            function searchStudent(classData, input) {
                var inputTokens = tokenizeName(input);

                var bestMatchIndex = -1;
                var bestMatchScore = 0;
                var sameScoreCount = 0;
                for (var i = 0; i < classData.searchIndex.length; i++) {
                    var score = getMatchScore(inputTokens, classData.searchIndex[i].tokens);
                    if (score > bestMatchScore) {
                        bestMatchIndex = i;
                        bestMatchScore = score;
                        sameScoreCount = 0;
                    } else if (score === bestMatchScore) {
                        sameScoreCount++;
                    }
                }

                // Multiple matches with the same score means that we aren't
                // sure.
                if (bestMatchIndex === -1 || sameScoreCount > 0)
                    return null;

                var bestMatch = classData.searchIndex[bestMatchIndex];
                return {
                    index: bestMatchIndex,
                    name: classData.groups[bestMatch.group][bestMatch.index],
                    group: bestMatch.group,
                };
            }

            /**
             * DOM manipulation
             */

            var dom = {
                classSelect: document.getElementById("class-select"),
                nameInput: document.getElementById("name-input"),

                loading: document.getElementById("loading"),

                studentInfo: document.getElementById("student-info"),
                studentName: document.getElementById("student-name"),
                studentGroupNumber: document.getElementById("student-group-number"),
                collesWeeks: document.getElementById("student-colles-weeks"),
            };

            var uiState = {
                isLoadingVisible: false,
                isStudentInfoVisible: false,
                studentIndex: null,
                groupIndex: null,
            };

            dom.classSelect.addEventListener("change", function(e) {
                // Remember the class so that the user doesn't have to type it
                // on every page reload.
                if (window.localStorage !== undefined)
                    localStorage.setItem("class", dom.classSelect.value);
                
                selectedClass = dom.classSelect.value;
                loadDataForSelectedClass();
                
                refreshView();
            });

            dom.nameInput.addEventListener("input", function(e) {
                // Same as above.
                if (window.localStorage !== undefined)
                    localStorage.setItem("name", dom.nameInput.value);

                refreshView();
            });

            // Fill the inputs with the values that were entered previously
            // before the page was unloaded.
            if (window.localStorage !== undefined) {
                var previousClass = localStorage.getItem("class");
                if (previousClass !== null)
                    dom.classSelect.value = previousClass;

                var previousName = localStorage.getItem("name");
                if (previousName !== null) {
                    dom.nameInput.value = previousName;
                    refreshView();
                }
            }

            function createColleElement(classData, colle) {
                var $colle = document.createElement("li");
                $colle.classList.add("colle");
                $colle.classList.add("colle--" + colle.state);
                $colle.classList.add("colle--subject-" + colle.subject);

                var $subject = document.createElement("p");
                $subject.classList.add("colle__subject");
                $subject.textContent = classData.subjects[colle.subject];
                $colle.appendChild($subject);

                var days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
                var day = days[colle.day];

                var $info = document.createElement("p");
                $info.classList.add("colle__info");
                $info.appendChild(document.createTextNode(classData.teachers[colle.teacher]));
                $info.appendChild(document.createElement("br"));
                $info.appendChild(document.createTextNode("Salle " + colle.room));
                $info.appendChild(document.createElement("br"));
                $info.appendChild(document.createTextNode(day + " à " +
                    colle.startTime.getHours() + " h (" +
                    formatRelativeTime(new Date(), colle.startTime) + ")"));
                $colle.appendChild($info);

                return $colle;
            }

            function createWeekElement(classData, week) {
                var $week = document.createElement("section");
                $week.classList.add("week");

                var $weekTitle = document.createElement("h1");
                $weekTitle.classList.add("week__title");
                $weekTitle.textContent = "Semaine " + (week.index + 1) + " (" + week.day + "/" + week.month + ")";
                $week.appendChild($weekTitle);

                var $colles = document.createElement("ul");
                $colles.classList.add("week__colles");
                for (var i = 0; i < week.colles.length; i++)
                    $colles.appendChild(createColleElement(classData, week.colles[i]));
                $week.appendChild($colles);

                return $week;
            }

            function getWeeksForGroup(classData, groupIndex) {
                var colles = classData.colles[groupIndex];

                var now = new Date();
                var weeks = [];
                var lastWeekIndex = null;
                for (var i = 0; i < colles.length; i++) {
                    var colle = colles[i];
                    var colleType = classData.types[colle.type];

                    var weekParts = classData.weeks[colle.week].split("-");
                    var month = parseInt(weekParts[0]);
                    var day = parseInt(weekParts[1]);
                    var year = month < 9 ? 2021 : 2020;

                    var startTime = new Date(year, month - 1, day, colleType.time);
                    startTime.setDate(startTime.getDate() + colleType.day);

                    var state;
                    if (now.valueOf() - startTime.valueOf() > 1000 * 60 * 60) {
                        state = "done";
                    } else if (now.valueOf() - startTime.valueOf() >= 0) {
                        state = "doing";
                    } else {
                        state = "waiting";
                    }

                    if (weeks.length === 0 || colle.week !== lastWeekIndex) {
                        weeks.push({
                            index: colle.week,
                            month: month,
                            day: day,
                            colles: [],
                        });
                    }

                    weeks[weeks.length - 1].colles.push({
                        startTime: startTime,
                        state: state,
                        day: colleType.day,
                        subject: colleType.subject,
                        teacher: colleType.teacher,
                        room: colleType.room,
                    });
                    lastWeekIndex = colle.week;
                }

                // Sort the colles in chronological order.
                for (var i = 0; i < weeks.length; i++) {
                    weeks[i].colles.sort(function(a, b) {
                        return a.startTime.valueOf() - b.startTime.valueOf();
                    });
                }

                return weeks;
            }

            function refreshView() {
                var classData = dataByClass[selectedClass];

                var showLoading = classData === undefined &&
                    dom.nameInput.value.trim() !== "";
                if (showLoading !== uiState.isLoadingVisible) {
                    if (showLoading) {
                        dom.loading.classList.remove("loading--hidden");
                    } else {
                        dom.loading.classList.add("loading--hidden");
                    }
                    uiState.isLoadingVisible = showLoading;
                }

                var student = classData === undefined ? null :
                    searchStudent(classData, dom.nameInput.value);

                var showStudentInfo = student !== null;
                if (showStudentInfo !== uiState.isStudentInfoVisible) {
                    if (showStudentInfo) {
                        dom.studentInfo.classList.remove("student-info--hidden");
                    } else {
                        dom.studentInfo.classList.add("student-info--hidden");
                    }
                    uiState.isStudentInfoVisible = showStudentInfo;
                }

                if (showStudentInfo) {
                    if (uiState.studentIndex === null ||
                        selectedClass !== uiState.studentIndex[0] ||
                        student.index !== uiState.studentIndex[1]) {
                        dom.studentName.textContent = student.name;
                        uiState.studentIndex = [selectedClass, student.index];
                    }

                    if (uiState.groupIndex === null ||
                        selectedClass !== uiState.groupIndex[0] ||
                        student.group !== uiState.groupIndex[1]) {
                        dom.studentGroupNumber.textContent = student.group + 1;

                        var weeks = getWeeksForGroup(classData, student.group);
                        // Remove weeks where all colles are already done.
                        weeks = weeks.filter(function(w) {
                            return w.colles
                                .some(function(c) {
                                    return c.state !== "done";
                                });
                        });

                        while (dom.collesWeeks.firstChild !== null)
                            dom.collesWeeks.removeChild(dom.collesWeeks.firstChild);
                        for (var i = 0; i < weeks.length; i++)
                            dom.collesWeeks.appendChild(createWeekElement(classData, weeks[i]));

                        uiState.groupIndex = [selectedClass, student.group];
                    }
                }
            }

            /**
             * Data loading
             */

            var pending = [];

            function loadDataForSelectedClass() {
                var classId = selectedClass;

                // Check if the data for that class was already loaded.
                if (dataByClass[classId] !== undefined)
                    return;

                // Check if the date is already being loaded (this can happen if
                // the user switches to another class and then switches back to
                // this class).
                if (pending.indexOf(classId) !== -1)
                    return;
                pending.push(classId);

                fetch("./data/" + classId + ".json")
                    .then(function(response) {
                        if (!response.ok)
                            throw new Error("response is not OK");
                        return response.json();
                    })
                    .then(function(responseJson) {
                        var classData = responseJson;

                        // Tokenize the names right away to make searching faster
                        classData.searchIndex = [];
                        for (var i = 0; i < classData.groups.length; i++) {
                            var group = classData.groups[i];
                            for (var j = 0; j < group.length; j++) {
                                classData.searchIndex.push({
                                    tokens: tokenizeName(group[j]),
                                    group: i,
                                    index: j,
                                });
                            }
                        }

                        dataByClass[classId] = classData;
                        refreshView();
                    })
                    .catch(function(err) {
                        console.error("failed to load data", err);
                    })
                    .then(function() {
                        // Remove from pending.
                        pending.splice(pending.indexOf(classId), 1);
                    });
            }
            
            selectedClass = dom.classSelect.value;
            loadDataForSelectedClass();
        </script>
    </body>
</html>
